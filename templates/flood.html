{% extends "base.html" %}

{% block title %}
Flood Risk - Disaster Prep Assistant
{% endblock %}

{% block content %}
<h2>üåä Flood Risk for ZIP {{ zip_code }}</h2>

<div id="map" style="height: 500px; margin-bottom: 1rem;"></div>

<h3>Chat with your Flood Safety Assistant</h3>
<div id="chat-box" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 10px; background: #fff;">
    {% for msg in chat %}
        {% if msg.role == "user" %}
            <div class="chat-message user" style="text-align: right; margin-bottom: 10px;">
                <strong>You:</strong> {{ msg.content }}
            </div>
        {% else %}
            <div class="chat-message bot" style="background-color: #e1f5fe; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                <strong>Assistant:</strong> {{ msg.content }}
            </div>
        {% endif %}
    {% endfor %}

    {% if reply %}
        <div class="chat-message bot" style="background-color: #e1f5fe; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
            <strong>Assistant:</strong> {{ reply }}
        </div>
    {% endif %}
</div>

<form method="POST" class="mt-3">
    <div class="input-group">
        <input type="text" class="form-control" name="message" placeholder="Ask a flood safety question..." required autofocus>
        <button class="btn btn-primary" type="submit" style="background-color:#0288d1; border:none;">Send</button>
    </div>
</form>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// Initialize map centered on Alameda County
const map = L.map('map').setView([37.669199, -121.906442], 10);

// Add OpenStreetMap tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Add user's ZIP code boundary
{% if zip_geojson %}
const userZipData = {{ zip_geojson | safe }};
const userZipLayer = L.geoJSON(userZipData, {
    style: {
        color: '#ff4444',
        weight: 3,
        fillColor: '#ff4444',
        fillOpacity: 0.2
    }
}).addTo(map);
map.fitBounds(userZipLayer.getBounds());
{% else %}
console.warn("ZIP GeoJSON not available.");
{% endif %}

// Load flood zones
fetchFloodZones();

function fetchFloodZones() {
    const paths = [
        '/static/Flood_Control_District_Zones.geojson',
        '/static/flood_zones.geojson',
        '/static/flood_control_zones.geojson',
        '/flood_data'  // fallback route
    ];
    tryLoadFloodPath(0);

    function tryLoadFloodPath(index) {
        if (index >= paths.length) {
            showFloodDataError("Flood zone data could not be loaded from any known source.");
            return;
        }

        fetch(paths[index])
            .then(res => {
                if (!res.ok) throw new Error("Fetch failed.");
                return res.json();
            })
            .then(data => {
                renderFloodZones(data);
            })
            .catch(() => {
                tryLoadFloodPath(index + 1);
            });
    }
}

function renderFloodZones(data) {
    // Convert GeometryCollection to FeatureCollection
    if (data.type === 'GeometryCollection') {
        data = {
            type: 'FeatureCollection',
            features: data.geometries.map(geom => ({
                type: 'Feature',
                geometry: geom,
                properties: {}
            }))
        };
    }

    L.geoJSON(data, {
        style: {
            color: '#0288d1',
            weight: 2,
            fillColor: '#81d4fa',
            fillOpacity: 0.4
        },
        onEachFeature: (feature, layer) => {
            let popup = '<strong>Flood Control District Zone</strong><br>';
            for (const key in feature.properties) {
                const val = feature.properties[key];
                if (val) popup += `<strong>${key}:</strong> ${val}<br>`;
            }
            layer.bindPopup(popup);
        }
    }).addTo(map);
}

function showFloodDataError(msg) {
    const errorDiv = document.createElement('div');
    errorDiv.innerHTML = `
        <div style="position: absolute; top: 10px; right: 10px; background: #ffccbc; padding: 10px; border-radius: 8px; color: #c62828; font-weight: bold;">
            ‚ö†Ô∏è ${msg}
        </div>
    `;
    document.getElementById('map').appendChild(errorDiv);
}
</script>
{% endblock %}
